<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF.js Viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #494949;
    }
    #viewerContainer {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      cursor: grab;
    }
    #viewerContainer.grabbing {
      cursor: grabbing;
    }
    #pdfContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    #pdfViewer {
      position: relative;
      margin: 0 auto;
      transform-origin: center center;
      transform: scale(1);
      transition: transform 0.05s linear;
    }
    .page {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      background-color: white;
      margin: 20px auto;
      display: none; 
    }
    .page.active {
      display: block;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-family: Arial, sans-serif;
      font-size: 16px;
      color: white;
    }
    .error {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <div id="viewerContainer">
    <div id="pdfContainer">
      <div id="pdfViewer" class="loading">Laddar PDF...</div>
    </div>
  </div>

  <script>
    // Konfigurera PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Hämta PDF URL och andra parametrar från query
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    let pdf = null;
    let currentPage = 1;
    let totalPages = 0;
    let currentScale = 1.2;
    let lastRenderedScale = 1.2;
    const container = document.getElementById('pdfViewer');
    const pdfContainer = document.getElementById('pdfContainer');
    const viewerContainer = document.getElementById('viewerContainer');
    
    // Variabler för dragfunktionalitet
    let isDragging = false;
    let startPoint = { x: 0, y: 0 };
    let scrollStart = { left: 0, top: 0 };
    
    // Lyssna på meddelanden från förälderkomponenten
    window.addEventListener('message', function(event) {
      // Endast acceptera meddelanden från vår egen domän
      if (event.origin !== window.location.origin && 
          getQueryParam('parentOrigin') && 
          event.origin !== getQueryParam('parentOrigin')) {
        return;
      }
      
      const message = event.data;
      
      if (message.type === 'nextPage') {
        if (currentPage < totalPages) {
          currentPage++;
          renderCurrentPage();
        }
      } else if (message.type === 'prevPage') {
        if (currentPage > 1) {
          currentPage--;
          renderCurrentPage();
        }
      } else if (message.type === 'setZoom') {
        if (message.zoom) {
          setNewZoom(message.zoom);
        }
      } else if (message.type === 'jumpToPage') {
        if (message.page && message.page >= 1 && message.page <= totalPages) {
          currentPage = message.page;
          renderCurrentPage();
        }
      }
    });

    // Funktion för att sätta ny zoomnivå med flytande övergång
    function setNewZoom(newScale) {
      currentScale = newScale;
      applyZoom();
    }

    // Applicera zoom direkt på container
    function applyZoom() {
      container.style.transform = `scale(${currentScale})`;
      
      // Skicka uppdatering till parent
      updateParent();
    }

    // Funktion för att uppdatera parent-komponenten
    function updateParent() {
      try {
        // Försök skicka status till föräldern via window.parent
        if (window.parent && window.parent !== window) {
          window.parent.updatePDFStatus?.({
            page: currentPage,
            totalPages: totalPages
          });
          
          window.parent.updateZoomLevel?.(currentScale);
        }
      } catch (e) {
        console.error('Kunde inte skicka status till parent:', e);
      }
    }

    // Cache för rendererade sidor
    const pageCache = {};

    // Funktion för att rendera enbart den aktiva sidan
    async function renderCurrentPage() {
      if (!pdf) return;
      
      // Ta bort alla synliga sidor
      const existingPages = container.querySelectorAll('.page');
      existingPages.forEach(page => {
        if (page.classList.contains('active')) {
          page.classList.remove('active');
        }
      });
      
      // Kolla om sidan redan finns i cachen
      const cacheKey = `page_${currentPage}`;
      let pageContainer = pageCache[cacheKey];
      
      if (!pageContainer) {
        try {
          // Hämta sidan från PDF-dokumentet
          const page = await pdf.getPage(currentPage);
          
          // Skapa en container för sidan
          pageContainer = document.createElement('div');
          pageContainer.className = 'page page-' + currentPage + ' active';
          container.appendChild(pageContainer);
          
          // Beräkna viewport baserat på originalskala (1.0)
          // Vi använder sedan CSS transform för att zooma, så vi renderar alltid i standardstorlek
          const viewport = page.getViewport({ scale: 1.0 });
          pageContainer.style.width = viewport.width + 'px';
          pageContainer.style.height = viewport.height + 'px';
          
          // Skapa canvas för rendering
          const canvas = document.createElement('canvas');
          pageContainer.appendChild(canvas);
          
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          // Rendera sida till canvas
          const renderContext = {
            canvasContext: context,
            viewport: viewport
          };
          
          await page.render(renderContext).promise;
          
          // Spara i cachen
          pageCache[cacheKey] = pageContainer;
          
        } catch (error) {
          console.error('Fel vid rendering av sida:', error);
        }
      } else {
        // Använd den befintliga sidan från cachen
        if (!container.contains(pageContainer)) {
          container.appendChild(pageContainer);
        }
      }
      
      // Markera sidan som aktiv
      if (pageContainer) {
        pageContainer.classList.add('active');
      }
      
      // Uppdatera zoom
      applyZoom();
      
      // Uppdatera statusen
      updateParent();
    }

    // Implementera dragfunktionalitet
    function setupDragAndDrop() {
      // Starta drag
      viewerContainer.addEventListener('mousedown', function(e) {
        isDragging = true;
        viewerContainer.classList.add('grabbing');
        startPoint = { x: e.clientX, y: e.clientY };
        scrollStart = { 
          left: pdfContainer.scrollLeft, 
          top: pdfContainer.scrollTop 
        };
        e.preventDefault();
      });
      
      // Avsluta drag
      viewerContainer.addEventListener('mouseup', function() {
        isDragging = false;
        viewerContainer.classList.remove('grabbing');
      });
      
      viewerContainer.addEventListener('mouseleave', function() {
        isDragging = false;
        viewerContainer.classList.remove('grabbing');
      });
      
      // Panorera när musen flyttas
      viewerContainer.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const dx = e.clientX - startPoint.x;
        const dy = e.clientY - startPoint.y;
        
        pdfContainer.scrollLeft = scrollStart.left - dx;
        pdfContainer.scrollTop = scrollStart.top - dy;
      });
    }

    // Hantera scroll och zoom
    function setupScrollAndZoom() {
      // Hantera mushjul för zoom när Ctrl är nedtryckt
      viewerContainer.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
          e.preventDefault();
          
          // Beräkna nya skalan, med mjuk justering
          const delta = e.deltaY > 0 ? -0.05 : 0.05;
          const newScale = Math.max(0.5, Math.min(3, currentScale + delta));
          
          // Animera zoom med CSS
          setNewZoom(newScale);
        } else {
          // Normal scrollning
          pdfContainer.scrollTop += e.deltaY;
          pdfContainer.scrollLeft += e.deltaX;
        }
      }, { passive: false });
      
      // Hantera tangentbordsnavigering
      document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowRight' || e.key === 'PageDown') {
          if (currentPage < totalPages) {
            currentPage++;
            renderCurrentPage();
          }
        } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
          if (currentPage > 1) {
            currentPage--;
            renderCurrentPage();
          }
        }
      });
    }

    // Rendera PDF med PDF.js
    async function renderPDF() {
      const url = getQueryParam('url');
      const initialZoom = getQueryParam('zoom');
      
      if (!url) {
        container.textContent = 'Ingen PDF URL angiven';
        container.classList.add('error');
        return;
      }

      try {
        if (initialZoom) {
          currentScale = parseFloat(initialZoom);
        }
        
        // Ladda PDF
        const loadingTask = pdfjsLib.getDocument(url);
        pdf = await loadingTask.promise;
        totalPages = pdf.numPages;
        
        container.innerHTML = '';
        container.classList.remove('loading');
        
        // Sätt upp interaktivitet
        setupScrollAndZoom();
        setupDragAndDrop();
        
        // Rendera första sidan
        renderCurrentPage();
        
        // Skicka initial status till parent
        updateParent();
      } catch (error) {
        console.error('Fel vid laddning av PDF:', error);
        container.textContent = `Kunde inte ladda PDF: ${error.message}`;
        container.classList.add('error');
      }
    }

    // Ladda PDF när sidan är klar
    document.addEventListener('DOMContentLoaded', renderPDF);
  </script>
</body>
</html>